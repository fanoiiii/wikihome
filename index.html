<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Wikipedia Homepage</title>
  <style>
    body { font-family: sans-serif; padding: 2em; }
    button { padding: 6px 12px; }
  </style>
  <script>
    const CACHE_KEY = "wiki_cache_v1";
    const VISITED_KEY = "visited_articles_v1";
    const MAX_CACHE = 10;
    const MAX_VISITED = 1000;

    const BANNED_KEYWORDS = [
      "porn", "sexual", "nudity", "NSFW", "fetish", "hentai", "genital", "erotic", "murder", "rape",
      "terrorist", "cartel", "assault", "execution", "abuse", "torture", "incest", "slavery", "necrophilia",
      "song", "single", "album", "mixtape", "track", "music video", "dj", "comedian", "celebrity", "idol",
      "boy band", "girl group", "filmography", "stand-up"
    ];

    const BANNED_CATEGORIES = [
      "footballers", "cricketers", "rugby", "basketball players", "athletes", "sportspeople", "medalists",
      "songs", "albums", "singles", "mixtapes", "music videos", "films", "film characters", "television",
      "fictional characters", "anime", "soap operas", "cartoons", "stubs"
    ];

    const BOOST_KEYWORDS = ["law", "principle", "effect", "paradox"];

    const BLOCKED_PATTERNS = [
      /\\((pitcher|cricketer|footballer|athlete)\\)/i,
      /[0-9]{4}.*(Cup|League|Tournament|Championship)/i
    ];

    function isFilteredTitle(title) {
      const lower = title.toLowerCase();
      if (BANNED_KEYWORDS.some(kw => lower.includes(kw))) {
        console.log("⛔ Rejected by keyword:", title);
        return true;
      }
      if (lower.includes("(disambiguation)") || lower.startsWith("wikipedia:") || lower.startsWith("help:") || lower.startsWith("template:")) {
        console.log("⛔ Rejected by admin/disambiguation:", title);
        return true;
      }
      if (BLOCKED_PATTERNS.some(re => re.test(title))) {
        console.log("⛔ Rejected by pattern:", title);
        return true;
      }
      return false;
    }

    async function fetchCategories(title) {
      const url = "https://en.wikipedia.org/w/api.php?" + new URLSearchParams({
        action: "query",
        prop: "categories",
        format: "json",
        cllimit: "500",
        titles: title,
        origin: "*"
      });
      try {
        const res = await fetch(url);
        const data = await res.json();
        const pages = Object.values(data.query.pages);
        return (pages[0]?.categories || []).map(c => c.title.toLowerCase());
      } catch {
        return [];
      }
    }

    async function isFilteredByCategory(title) {
      const cats = await fetchCategories(title);
      const blocked = cats.some(cat => BANNED_CATEGORIES.some(b => cat.includes(b)));
      if (blocked) console.log("⛔ Rejected by category:", title);
      return blocked;
    }

    async function fetchRandomArticles() {
      const url = "https://en.wikipedia.org/w/api.php?" + new URLSearchParams({
        action: "query",
        format: "json",
        list: "random",
        rnnamespace: 0,
        rnlimit: 10,
        origin: "*"
      });
      const res = await fetch(url);
      const data = await res.json();
      return data.query.random.map(p => p.title);
    }

    function getCache() {
      try {
        return JSON.parse(localStorage.getItem(CACHE_KEY)) || [];
      } catch { return []; }
    }

    function setCache(arr) {
      localStorage.setItem(CACHE_KEY, JSON.stringify(arr.slice(0, MAX_CACHE)));
    }

    function popFromCache() {
      const queue = getCache();
      const next = queue.shift();
      setCache(queue);
      return next;
    }

    function logVisit(title) {
      const visited = JSON.parse(localStorage.getItem(VISITED_KEY)) || [];
      visited.push(title);
      localStorage.setItem(VISITED_KEY, JSON.stringify(visited.slice(-MAX_VISITED)));
    }

    function exportVisited() {
      const visited = JSON.parse(localStorage.getItem(VISITED_KEY)) || [];
      const blob = new Blob([visited.join("\\n")], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "visited_wikipedia_urls.txt";
      a.click();
    }

    function boostSort(titles) {
      return titles.sort((a, b) => {
        const aBoost = BOOST_KEYWORDS.some(k => a.toLowerCase().includes(k));
        const bBoost = BOOST_KEYWORDS.some(k => b.toLowerCase().includes(k));
        return (bBoost - aBoost);
      });
    }

    async function refillCache() {
      const titles = boostSort(await fetchRandomArticles());

      const results = await Promise.allSettled(titles.map(async title => {
        if (isFilteredTitle(title)) return null;
        if (await isFilteredByCategory(title)) return null;
        return title;
      }));

      const valid = results
        .filter(r => r.status === "fulfilled" && r.value)
        .map(r => r.value);

      const current = getCache();
      setCache(current.concat(valid));
      console.log("✅ Refilled cache with:", valid);
    }

    async function startRedirect() {
      const cached = getCache();
      if (cached.length === 0) {
        await refillCache();
      }
      const next = popFromCache();
      if (next) {
        logVisit(next);
        window.location.href = "https://en.wikipedia.org/wiki/" + encodeURIComponent(next);
      } else {
        document.body.innerText = "❌ No suitable article found.";
      }
    }

    window.addEventListener("load", () => {
      document.getElementById("exportBtn").onclick = exportVisited;
      startRedirect();
    });

    setInterval(() => {
      if (getCache().length < MAX_CACHE) refillCache();
    }, 1000 * 60 * 5);
  </script>
</head>
<body>
  <p>🔍 Loading a Wikipedia article…</p>
  <button id="exportBtn">⬇️ Export Visited URLs</button>
</body>
</html>
